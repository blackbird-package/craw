#!/bin/bash


## CRAW KEY LUKS DRIVE ENCRYPTION
## development by null
## copyright@2025 PT LEKTOR MEDIA UTAMA


clear
echo "-------------------------------------------------"
echo " Craw : Crypto Vault Manager"
echo " development by null@2025"
echo "-------------------------------------------------"


ringgrups=$( sudo lvs | grep "ring" | awk $'{ print $2 }')
ringparse="/dev/$ringgrups/ring"

silogrups=$( sudo lvs | grep "silo" | awk $'{ print $2 }')
siloparse="/dev/$silogrups/silo"


function craw_open_ring_device() {

    echo " OPENING : Insert crypto disk password"
    echo "-------------------------------------------------"
    sudo cryptsetup luksOpen $ringparse lvm_ring

    if [[ ! -d "$HOME/.ssh"  ]];then
        sudo mkdir -R -p "$HOME/.ssh"
        sudo chmod -R 700 "$HOME/.ssh"
    fi
    
    sudo mount /dev/mapper/lvm_ring "$HOME/.ssh"
    sudo chown -R $USER:$USER "$HOME/.ssh"
}


function craw_exit_ring_device() {

    echo " CLOSING : Encrypting crypto disk device"
    echo "-------------------------------------------------"

    mountar=$(lsblk | grep "$HOME/.ssh")
    mountsc="/dev/mapper/lvm_ring"

    if [[ ! -z $mounted ]] || [[ -e $mountsc ]];then
        cd ~ && sudo umount -R "$HOME/.ssh"
        sudo cryptsetup luksClose /dev/mapper/lvm_ring
    fi
}


function craw_ring_init() {

    if [[ -e $ringparse ]];then
        if [[ ! -e /dev/mapper/lvm_ring ]];then
            craw_open_ring_device
        else
            craw_exit_ring_device
        fi
    fi
}


function craw_open_silo_device() {

    echo " OPENING : Insert cryto password"
    echo "-------------------------------------------------"
    sudo cryptsetup luksOpen $siloparse lvm_silo

    sudo mount -m /dev/mapper/lvm_silo "/run/user/$UID/silo"
    sudo chown -R $USER:$USER "/run/user/$UID/silo"
    ln -s "/run/user/$UID/silo" "$HOME/silo"
}


function craw_exit_silo_device() {

    echo " CLOSING : Encrypting crypto disk device"
    echo "-------------------------------------------------"

    mountsc="/dev/mapper/lvm_silo"

    if [[ ! -z $mounted ]] || [[ -e $mountsc ]];then
        cd ~ && 
        rm "$HOME/silo"
        sudo chown -R root:root "/run/user/$UID/silo" &&
        sudo umount "/run/user/$UID/silo" &&
        sudo cryptsetup luksClose /dev/mapper/lvm_silo
    fi
}


function craw_silo_init() {
    if [[ -e $siloparse ]];then
        if [[ ! -e "/dev/mapper/lvm_silo" ]];then
            silo_open_ring_device
        else
            silo_close_ring_device
        fi
    fi
}


if [[ $1 == "keys" ]] && [[ ! -z $1 ]];then

    craw_ring_init

elif [[ $1 == "silos" ]] && [[ ! -z $1 ]];then

    craw_silo_init

else
    echo "Error : command need parameter or paramenter its not available"
fi